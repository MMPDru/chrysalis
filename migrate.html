<!DOCTYPE html>
<html>

<head>
    <title>Migration Script</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDuN2mc1B6r58jsY3tKMDFsZEwz-SIBS2I",
            authDomain: "chrysalis-app-10581.firebaseapp.com",
            projectId: "chrysalis-app-10581",
            storageBucket: "chrysalis-app-10581.firebasestorage.app",
            messagingSenderId: "604659771909",
            appId: "1:604659771909:web:2c0df36fb0f8fcc0ed82c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const SOURCE_UID = 'QlWbFRHI6ASeZW1ciKrf0UoFq7I3'; // test+verify@example.com
        const DEST_UID = 'Y17f3dSbvyO8v8uEcflY4WRsErz1';   // d.pio@pbizi.com

        async function migrateCollection(collectionName) {
            const log = document.getElementById('log');
            log.innerHTML += `<br>Checking ${collectionName}...`;

            const q = query(collection(db, collectionName), where('userId', '==', SOURCE_UID));
            const snapshot = await getDocs(q);

            log.innerHTML += ` Found ${snapshot.size} documents`;

            let count = 0;
            for (const docSnap of snapshot.docs) {
                await updateDoc(docSnap.ref, { userId: DEST_UID });
                count++;
            }

            if (count > 0) {
                log.innerHTML += ` - Migrated ${count}`;
            }
            return count;
        }

        window.runMigration = async function () {
            const log = document.getElementById('log');
            log.innerHTML = 'Starting migration...';
            log.innerHTML += `<br>From: test+verify@example.com (${SOURCE_UID})`;
            log.innerHTML += `<br>To: d.pio@pbizi.com (${DEST_UID})`;

            try {
                let total = 0;
                total += await migrateCollection('chapters');
                total += await migrateCollection('versions');
                total += await migrateCollection('visualAssets');
                total += await migrateCollection('wisdomLibrary');
                total += await migrateCollection('tiktokScripts');

                log.innerHTML += `<br><br><b>✅ Done! Migrated ${total} total documents</b>`;
            } catch (error) {
                log.innerHTML += `<br><br><b>❌ Error: ${error.message}</b>`;
                console.error(error);
            }
        };
    </script>
</head>

<body style="font-family: monospace; padding: 20px;">
    <h2>Firebase User Data Migration</h2>
    <p>This will transfer all data from test+verify@example.com to d.pio@pbizi.com</p>
    <button onclick="runMigration()" style="padding: 10px 20px; font-size: 16px;">Run Migration</button>
    <div id="log" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;"></div>
</body>

</html>